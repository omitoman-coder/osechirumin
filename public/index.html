<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>オセちるみん 伝説の始まり</title>
<style>
/* （CSSは前と同じなので省略してOK。必要ならそのまま使える） */
</style>
</head>
<body>
<h1>オセちるみん Ver7</h1>
<div id="controls">
    <button class="btn" onclick="chooseColor()">先攻？後攻？</button>
    <button class="btn" onclick="startAIGame('weak')">ちる弱</button>
    <button class="btn" onclick="startAIGame('normal')">ちる普</button>
    <button class="btn" onclick="startAIGame('strong')">ちる強</button>
    <button class="btn" onclick="startOnline()">オンライン対戦</button>
</div>
<div id="board">
    <div id="message"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const board=document.getElementById('board');
const SIZE=8;
let cells=[], boardState=[], currentPlayer=null, aiStrength='normal', myColor=null, aiEnabled=false, gameStarted=false;

// 角音一度再生管理
let cornersTaken = { '0,0':false, '0,7':false, '7,0':false, '7,7':false };

// メッセージ表示
const messageEl=document.getElementById('message');
function showMessage(msg, duration=1500){
    messageEl.textContent=msg;
    messageEl.style.display='block';
    if(duration>0) setTimeout(()=>{messageEl.style.display='none';}, duration);
}

// 音声（省略、前回のまま）

// --- 中略：セル生成、initBoard(), renderBoard(), flipPiece() など前回と同じ ---

function checkGameOver(){
    const blackMoves = hasValidMove('black');
    const whiteMoves = hasValidMove('white');

    if(!blackMoves && !whiteMoves){
        const counts = countDisks();
        let resultMsg="";
        if(counts.black > counts.white){ 
            resultMsg=`黒の勝ち！ (${counts.black} 対 ${counts.white})`;
            sounds.win.play(); 
        }
        else if(counts.white > counts.black){ 
            resultMsg=`白の勝ち！ (${counts.white} 対 ${counts.black})`;
            sounds.lose.play(); 
        }
        else resultMsg=`引き分け！ (${counts.black} 対 ${counts.white})`;

        showMessage(resultMsg,3000);
        gameStarted=false;
        return true;
    }
    return false;
}

// --- 中略：checkSkip, handleMove, aiMove などは前と同じ ---

function startAIGame(level){
    if(!myColor){ alert('まず先攻？後攻？ボタンを押してください'); return; }

    aiEnabled=true;
    aiStrength=level;
    initBoard();

    if(level==='weak') sounds.start_weak.play();
    else if(level==='normal') sounds.start_normal.play();
    else if(level==='strong') sounds.start_strong.play();

    showMessage('ゲーム開始！',2000);

    // もしAIが先攻（黒）なら自動で初手を打つ
    if(currentPlayer!==myColor) setTimeout(aiMove,800);
}

function startOnline(){
    if(!myColor){ alert('まず先攻？後攻？ボタンを押してください'); return; }

    aiEnabled=false;
    initBoard();

    sounds.start_online.play();
    showMessage('ゲーム開始！',2000);
}

function chooseColor(){
    const colors=['white','black'];
    myColor=colors[Math.floor(Math.random()*2)];

    // 自分が黒なら自分が先手、自分が白なら相手(AI/オンライン)が先手
    currentPlayer='black'; 

    showMessage(`あなたは${myColor==='white'?'白です（後攻）':'黒です（先攻）'}`,2000);
}

socket.on('move',data=>{
    boardState[data.y][data.x]=data.color;
    flipPiece(data.x,data.y,data.color,true);
    switchTurn();
    renderBoard();
    if(!checkSkip(false,true)) return;
    showMessage(currentPlayer===myColor?'あなたの番です':'あいての番です',1500);
});

window.onload=()=>{ initBoard(); }
</script>
</body>
</html>