<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>オセちるみん 伝説の始まり</title>
<style>
body { font-family: Arial,sans-serif; display:flex; flex-direction:column; align-items:center; background:#ffe4f0; margin:0; padding:0; }
h1 { color:#ff69b4; margin-top:20px; text-shadow:1px 1px 2px #fff; }
#controls { margin:10px 0; display:flex; flex-wrap:wrap; justify-content:center; }
.btn { background-color:#ffb6c1; border:none; border-radius:15px; padding:10px 20px; margin:5px; font-size:16px; cursor:pointer; transition:0.2s; }
.btn:hover { background-color:#ff69b4;color:#fff; }
#board { display:grid; grid-template-columns:repeat(8,1fr); gap:0; width:90vw; max-width:650px; aspect-ratio:1/1; background-image:url('board.png'); background-size:cover; background-position:center; border:2px solid #000; position:relative; }
.cell { border:1px solid rgba(0,0,0,0.3); position:relative; touch-action:manipulation; }
.piece { width:80%; height:80%; border-radius:50%; position:absolute; top:10%; left:10%; transform-style:preserve-3d; backface-visibility:hidden; transition:transform 0.4s ease; }
.flip { transform:rotateY(180deg); }
.piece img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
#message { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:36px; font-weight:bold; color:red; pointer-events:none; display:none; text-align:center; z-index:10; text-shadow:2px 2px #fff; white-space:pre-line; }
@media (max-width:600px){ .btn{padding:8px 15px;font-size:14px;} #message{font-size:28px;} }
@keyframes aiSkipFlip { 0% { transform: translateY(0); } 25% { transform: translateY(-10%); } 50% { transform: translateY(0); } 75% { transform: translateY(-5%); } 100% { transform: translateY(0); } }
.ai-skip-flip { animation: aiSkipFlip 0.8s ease; }
</style>
</head>
<body>
<h1>オセちるみん 伝説の始まり</h1>
<div id="controls">
    <button class="btn" onclick="chooseColor()">先攻？後攻？</button>
    <button class="btn" onclick="startAIGame('weak')">ちる弱</button>
    <button class="btn" onclick="startAIGame('normal')">ちる普</button>
    <button class="btn" onclick="startAIGame('strong')">ちる強</button>
    <button class="btn" onclick="startOnline()">オンライン対戦</button>
</div>
<div id="board">
    <div id="message"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const board=document.getElementById('board');
const SIZE=8;
let cells=[], boardState=[], currentPlayer=null, aiStrength='normal', myColor=null, aiEnabled=false, gameStarted=false;

// 角音一度再生管理
let cornersTaken = { '0,0':false, '0,7':false, '7,0':false, '7,7':false };

// メッセージ表示
const messageEl=document.getElementById('message');
function showMessage(msg, duration=2000){
    messageEl.textContent=msg;
    messageEl.style.display='block';
    if(duration>0) setTimeout(()=>{messageEl.style.display='none';}, duration);
}

// 音声
const sounds={
    start_weak:new Audio('start_weak.mp3'),
    start_normal:new Audio('start_normal.mp3'),
    start_strong:new Audio('start_strong.mp3'),
    start_online:new Audio('start_online.mp3'),
    1:new Audio('flip1.mp3'),
    2:new Audio('flip2.mp3'),
    3:new Audio('flip3.mp3'),
    4:new Audio('flip4.mp3'),
    corner:new Audio('corner.mp3'),
    win:new Audio('win.mp3'),
    lose:new Audio('lose.mp3')
};
for(const k in sounds) sounds[k].volume=1.0;

// セル生成
for(let y=0;y<SIZE;y++){
    cells[y]=[];
    for(let x=0;x<SIZE;x++){
        const div=document.createElement('div');
        div.classList.add('cell');
        div.dataset.x=x; div.dataset.y=y;
        div.addEventListener('click', ()=>handleMove(x,y));
        board.appendChild(div);
        cells[y][x]=div;
    }
}

// 初期化
function initBoard(){
    boardState=Array(SIZE).fill(null).map(()=>Array(SIZE).fill(null));
    boardState[3][3]='white'; boardState[3][4]='black';
    boardState[4][3]='black'; boardState[4][4]='white';
    renderBoard();
    gameStarted=true;
}

// 描画
function renderBoard(){
    for(let y=0;y<SIZE;y++){
        for(let x=0;x<SIZE;x++){
            if(boardState[y][x]) flipPiece(x,y,boardState[y][x],false);
            else cells[y][x].innerHTML='';
        }
    }
}

// 駒描画（角音確実再生版）
function flipPiece(x,y,color,animate=true){
    const cell=cells[y][x];
    
    // 角音再生
    if((x===0||x===7)&&(y===0||y===7) && !cornersTaken[`${x},${y}`]){
        sounds.corner.play();
        cornersTaken[`${x},${y}`]=true;
    }

    // 駒生成
    cell.innerHTML='';
    const piece=document.createElement('div'); piece.classList.add('piece');
    const img=document.createElement('img'); img.src=color==='black'?'black.png':'white.png';
    piece.appendChild(img); cell.appendChild(piece);

    if(animate){
        piece.style.transform='rotateY(180deg)';
        setTimeout(()=>{piece.classList.add('flip');},10);
    }
}

// --- 以下は元の正常動作コードをそのまま維持 ---
function isValidMove(x,y,color){
    if(boardState[y][x]) return false;
    const opponent=(color==='black')?'white':'black';
    const dirs=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
    for(const [dx,dy] of dirs){
        let nx=x+dx, ny=y+dy, found=false;
        while(nx>=0&&nx<8&&ny>=0&&ny<8&&boardState[ny][nx]===opponent){
            nx+=dx; ny+=dy; found=true;
        }
        if(found && nx>=0&&nx<8&&ny>=0&&ny<8 && boardState[ny][nx]===color) return true;
    }
    return false;
}

function placeDisk(x,y,color){
    boardState[y][x]=color;
    const opponent=(color==='black')?'white':'black';
    const dirs=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
    let flipped=0;
    for(const [dx,dy] of dirs){
        let nx=x+dx, ny=y+dy, line=[];
        while(nx>=0&&nx<8&&ny>=0&&ny<8&&boardState[ny][nx]===opponent){
            line.push([nx,ny]);
            nx+=dx; ny+=dy;
        }
        if(line.length && nx>=0&&nx<8 && ny>=0&&ny<8 && boardState[ny][nx]===color){
            flipped+=line.length;
            for(const [fx,fy] of line) boardState[fy][fx]=color;
        }
    }
    if(flipped>=4) sounds[4].play();
    else if(flipped===3) sounds[3].play();
    else if(flipped===2) sounds[2].play();
    else if(flipped===1) sounds[1].play();
}

function switchTurn(){ currentPlayer=currentPlayer==='black'?'white':'black'; }

function hasValidMove(color){
    for(let y=0;y<8;y++){
        for(let x=0;x<8;x++){
            if(isValidMove(x,y,color)) return true;
        }
    }
    return false;
}

function countDisks(){
    let black=0, white=0;
    for(let y=0;y<8;y++){
        for(let x=0;x<8;x++){
            if(boardState[y][x]==='black') black++;
            else if(boardState[y][x]==='white') white++;
        }
    }
    return {black,white};
}

function checkGameOver(){
    const blackMoves = hasValidMove('black');
    const whiteMoves = hasValidMove('white');

    if(!blackMoves && !whiteMoves){
        const counts = countDisks();
        let result="";
        if(counts.black > counts.white){ result=`黒の勝ち！`; sounds.win.play(); }
        else if(counts.white > counts.black){ result=`白の勝ち！`; sounds.lose.play(); }
        else result=`引き分け！`;
        showMessage(`${result}\n黒:${counts.black}枚 白:${counts.white}枚`,4000);
        gameStarted=false;
        return true;
    }
    return false;
}

function checkSkip(isAI=false,isOnline=false){
    while(gameStarted && !hasValidMove(currentPlayer)){
        if(isAI) {
            showMessage('AIがスキップします');
            cells.flat().forEach(cell=>{
                if(cell.firstChild) {
                    cell.firstChild.classList.add('ai-skip-flip');
                    setTimeout(()=>{cell.firstChild.classList.remove('ai-skip-flip');},800);
                }
            });
        } else if(isOnline) showMessage('相手がスキップします');
        else showMessage('スキップします');

        switchTurn();
        if(checkGameOver()) return false;
    }
    return true;
}

function handleMove(x,y){
    if(!gameStarted || !myColor || currentPlayer!==myColor) return;
    if(!isValidMove(x,y,myColor)) return;

    placeDisk(x,y,myColor);
    flipPiece(x,y,myColor,true);
    switchTurn();
    renderBoard();

    if(!checkSkip()) return;
    showMessage(currentPlayer===myColor?'あなたの番です':'あいての番です');

    if(aiEnabled && currentPlayer!==myColor) setTimeout(aiMove,800);
}

function aiMove(){
    if(!gameStarted) return;

    if(!hasValidMove('white')){
        showMessage('AIがスキップします');
        switchTurn();
        if(!checkGameOver() && currentPlayer!==myColor) setTimeout(aiMove,800);
        return;
    }

    let moves=[];
    for(let y=0;y<8;y++){
        for(let x=0;x<8;x++){
            if(isValidMove(x,y,'white')) moves.push({x,y});
        }
    }
    if(moves.length===0) return;

    let move;
    if(aiStrength==='weak') move=moves[Math.floor(Math.random()*moves.length)];
    else if(aiStrength==='normal'){
        let max=-1;
        for(const m of moves){ let c=countFlips(m.x,m.y,'white'); if(c>max){max=c; move=m;} }
    } else {
        move=moves.find(m=>(m.x===0||m.x===7)&&(m.y===0||m.y===7)) || moves[0];
        let max=-1;
        for(const m of moves){ let c=countFlips(m.x,m.y,'white'); if(c>max){max=c; move=m;} }
    }

    placeDisk(move.x,move.y,'white');
    flipPiece(move.x,move.y,'white',true);
    switchTurn();
    renderBoard();

    if(!checkSkip()) return;
    showMessage('あなたの番です');

    if(currentPlayer!==myColor) setTimeout(aiMove,800);
}

function countFlips(x,y,color){
    let total=0;
    const opponent=(color==='black')?'white':'black';
    const dirs=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
    for(const [dx,dy] of dirs){
        let nx=x+dx, ny=y+dy, line=0;
        while(nx>=0&&nx<8&&ny>=0&&ny<8 && boardState[ny][nx]===opponent){
            line++; nx+=dx; ny+=dy;
        }
        if(line && nx>=0&&nx<8 && ny>=0&&ny<8 && boardState[ny][nx]===color) total+=line;
    }
    return total;
}

function startAIGame(level){
    if(!myColor){ alert('まず先攻？後攻？ボタンを押してください'); return; }

    aiEnabled=true;
    aiStrength=level;
    initBoard();

    if(level==='weak') sounds.start_weak.play();
    else if(level==='normal') sounds.start_normal.play();
    else if(level==='strong') sounds.start_strong.play();

    showMessage('ゲーム開始！',2000);

    // --- 修正：自分が黒のときのみAIが先手を打つ ---
    if(myColor==='black' && currentPlayer==='white') {
        setTimeout(aiMove,800);
    }
}

function startOnline(){
    if(!myColor){ alert('まず先攻？後攻？ボタンを押してください'); return; }

    aiEnabled=false;
    initBoard();

    sounds.start_online.play();
    showMessage('ゲーム開始！',2000);
}

function chooseColor(){
    const colors=['white','black'];
    myColor=colors[Math.floor(Math.random()*2)];

    // 白は先攻、黒は後攻に固定
    if(myColor==='white'){
        currentPlayer='white';
        showMessage('あなたは白です（先攻）',1500);
    } else {
        currentPlayer='white'; // 白から開始
        showMessage('あなたは黒です（後攻）',1500);
    }
}

// オンライン受信
socket.on('move',data=>{
    boardState[data.y][data.x]=data.color;
    flipPiece(data.x,data.y,data.color,true);
    switchTurn();
    renderBoard();
    if(!checkSkip(false,true)) return;
    showMessage(currentPlayer===myColor?'あなたの番です':'あいての番です',1500);
});

window.onload=()=>{ initBoard(); }
</script>
</body>
</html>